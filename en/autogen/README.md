# Autogeneration

MAVSDK is available in a number of different languages.
These all share the same "core" MAVLink implementation (written in C++), but almost all of the API-specific code for other languages is *autogenerated* from API definition files (and language-specific templates).

This approach means that we don't have to maintain a separate MAVLink implementation or API for each language.
New features are implemented (just once) in C++, and are then automatically available in Python, Mava, etc.

This topic provides an overview of the architecture and mechanisms.

## Overview

The common MAVLink implementation is written in C++ (it is part of MAVSDK-C++). 
The `mavsdk_server` exposes the MAVSDK-C++ API over [gRPC](https://grpc.io/) to the language bindings.
The API for all languages is autogenerated from a single common definition.

![MAVSDK structure/architecture](../../assets/autogen/mavsdk_overview.png)

The following parts are autogenerated:

* MAVSDK-C++ API (i.e. header files)
* Most of `mavsdk_server`
* Most of the language bindings

Those parts are maintained manually:

* MAVSDK-C++ implementation (i.e. the MAVLink business logic)
* New plugins need to be added to `mavsdk_server` (this may be automated in future)
* The `System` wrapper in language bindings usually needs to be updated whenever a new plugin is added (this may be automated in future)

The heart of the autogeneration system is the [MAVSDK-Proto](https://github.com/mavlink/mavsdk-proto) repository, which is described [below](#mechanisms).

## Autogeneration Mechanisms {#mechanisms}

The autogeneration pipeline is shown below:

![Autogeneration pipeline](../../assets/autogen/autogen_overview.png)

The main parts are:

* [`protoc-gen-mavsdk`](https://github.com/mavlink/MAVSDK-Proto/tree/master/pb_plugins), which is a `protoc` custom plugin generating MAVSDK's code.
* [The API definition](https://github.com/mavlink/MAVSDK-Proto/tree/master/protos), in the form of proto files.
* Template files (per language, see e.g. the [python templates](https://github.com/mavlink/MAVSDK-Python/tree/master/other/templates/py) or the [C++ templates](https://github.com/mavlink/MAVSDK/tree/develop/templates)).


`protoc` takes the custom plugin (`protoc-gen-mavsdk`) and the template files as inputs, and generate source code out of it.
The way it currently works is that it generates one source file out of each `*.proto` file. For instance, `action.proto` becomes `Action.java` in MAVSDK-Java.

In some languages (typically C++), we need to generate multiple source files out of one proto definition file, and this is the reason why the C++ generation script runs protoc [in](https://github.com/mavlink/MAVSDK/blob/develop/tools/generate_from_protos.sh#L72-L74) [multiple](https://github.com/mavlink/MAVSDK/blob/develop/tools/generate_from_protos.sh#L76-L77) [passes](https://github.com/mavlink/MAVSDK/blob/develop/tools/generate_from_protos.sh#L79-L81), once [for each template](https://github.com/mavlink/MAVSDK/blob/develop/tools/generate_from_protos.sh#L79-L81) (e.g. "templates/plugin_h" defines the templates to generate `action.h`, `telemetry.h`, ..., and "templates/plugin_cpp" is responsible for `action.cpp`, `telemetry.cpp`, ...).

All the MAVSDK repositories contain some kind of `generate_from_proto.sh` file, and a `templates/` directory:

* MAVSDK-C++: [script](https://github.com/mavlink/MAVSDK/blob/develop/tools/generate_from_protos.sh), [templates](https://github.com/mavlink/MAVSDK/tree/develop/templates)
* MAVSDK-Python: [script](https://github.com/mavlink/MAVSDK-Python/blob/master/other/tools/run_protoc.sh), [templates](https://github.com/mavlink/MAVSDK-Python/tree/master/other/templates/py)
* MAVSDK-Swift: [script](https://github.com/mavlink/MAVSDK-Swift/blob/master/tools/generate_from_protos.bash), [templates](https://github.com/mavlink/MAVSDK-Swift/tree/master/templates)
* MAVSDK-Java: [script](https://github.com/mavlink/MAVSDK-Java/blob/master/sdk/build.gradle#L54-L73), [templates](https://github.com/mavlink/MAVSDK-Java/tree/master/sdk/templates)
* MAVSDK-C#: [script](https://github.com/mavlink/MAVSDK-CSharp/blob/master/MAVSDK-CSharp/MAVSDK/MAVSDK.csproj#L18-L31), [templates](https://github.com/mavlink/MAVSDK-CSharp/tree/master/MAVSDK-CSharp/MAVSDK/templates)
* MAVSDK-Go: [script](https://github.com/mavlink/MAVSDK-Go/blob/master/tools/generate_from_protos.bash), [templates](https://github.com/mavlink/MAVSDK-Go/tree/master/templates)

## Adding a New Feature

To add a new feature:
- Add a new proto file to [MAVSDK-Proto](https://github.com/mavlink/mavsdk-proto), which defines and documents the desired API.
  > **Note** The API definition will be discussed/iterated with the core team before PR submission.
- Generate the C++ API using [Jonas Insert]
- Create a C++ implementation [Jonas, any advice?]
- ?
[Jonas, if they need more detail advice, point to "building"?]
